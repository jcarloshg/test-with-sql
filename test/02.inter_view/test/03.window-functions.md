A **Window Function** in SQL allows you to perform calculations across a specific set of rows (a "window") related to the current row, **without** collapsing the rows into a single output like `GROUP BY` does.

### The "Aha!" Moment

Think of it as looking at your data through a sliding window.

- **`GROUP BY`:** Takes 10 rows and squashes them into 1 summary row. You lose the individual details.
- **Window Function:** Keeps all 10 rows but adds a "magic column" next to each one containing the summary data (like a running total, rank, or average) for that group.

### Key Syntax

The magic keyword is `OVER()`.

```sql
SELECT
    employee_name,
    salary,
    -- This calculates the average salary of the entire department
    -- and puts that number next to EVERY employee in that department.
    AVG(salary) OVER (PARTITION BY department_id) as dept_avg_salary
FROM employees;

```

### The 3 Core Parts

1. **`OVER()`:** The signal that this is a window function.
2. **`PARTITION BY`:** Defines the "group" (e.g., "Calculate this separately for each Department").
3. **`ORDER BY`:** Defines the sequence inside the group (crucial for things like "Running Totals" or "Ranking").

### Common Use Cases

- **Ranking:** "Who are the top 3 earners in _each_ department?" (`RANK()`, `DENSE_RANK()`)
- **Running Totals:** "What is the cumulative revenue day by day?" (`SUM() OVER (ORDER BY date)`)
- **Comparing Previous Rows:** "How much did we grow compared to yesterday?" (`LAG()`)

# Most important Window functions

As a Senior Backend Lead, I break Window Functions down into three categories: **Ranking**, **Value Extraction**, and **Aggregation**.

Here is the list of the ones you will actually use in production.

---

### 1. Ranking Functions (The "Top N" Solvers)

These are used to assign a "place" to a row based on a value. Essential for leaderboards, pagination, or finding "latest" records.

| Function           | Logic                        | Example (Scores: 100, 100, 90) | Use Case                                                                |
| ------------------ | ---------------------------- | ------------------------------ | ----------------------------------------------------------------------- |
| **`ROW_NUMBER()`** | Unique ID for every row.     | **1, 2, 3**                    | Pagination; Deduplicating data (keep row #1, delete the rest).          |
| **`RANK()`**       | Skips numbers after ties.    | **1, 1, 3** (No "2")           | Olympic Medals (Two Golds means no Silver).                             |
| **`DENSE_RANK()`** | **Most Important.** No gaps. | **1, 1, 2**                    | "Top 3 highest salaries" (If two people are #1, the next person is #2). |

**Example:**

```sql
-- Find the top 2 highest paid employees per department
SELECT * FROM (
  SELECT name, salary,
         DENSE_RANK() OVER (PARTITION BY dept_id ORDER BY salary DESC) as rank
  FROM employees
) WHERE rank <= 2;

```

---

### 2. Value Extraction (The "Time Travelers")

These allow you to look at other rows without using a complex `SELF JOIN`.

| Function               | Description                            | Use Case                                          |
| ---------------------- | -------------------------------------- | ------------------------------------------------- |
| **`LAG(col, n)`**      | Look at the **previous** row.          | "Calculate Month-over-Month Growth."              |
| **`LEAD(col, n)`**     | Look at the **next** row.              | "How long until the _next_ order was placed?"     |
| **`FIRST_VALUE(col)`** | Returns the first value in the window. | "Compare everyone's score to the Winner's score." |

**Example:**

```sql
-- Calculate the difference in sales compared to yesterday
SELECT
  date,
  sales,
  sales - LAG(sales) OVER (ORDER BY date) as growth
FROM daily_sales;

```

---

### 3. Aggregate Window Functions (The "Running Logic")

These are standard math functions (`SUM`, `AVG`, `COUNT`) but used with `OVER()`.

| Function       | Description                     | Use Case                                                |
| -------------- | ------------------------------- | ------------------------------------------------------- |
| **`SUM(col)`** | Running Total (Cumulative Sum). | "Total revenue year-to-date."                           |
| **`AVG(col)`** | Moving Average.                 | "3-Day Moving Average" to smooth out stock price noise. |

**Example:**

```sql
-- Calculate a running total of revenue
SELECT
  date,
  revenue,
  SUM(revenue) OVER (ORDER BY date) as running_total
FROM sales_ledger;

```

### ðŸ† Expert Tip for Interviews

If you are asked **"How do you remove duplicate rows from a table that has no Primary Key?"**
**Answer:** "I would use a CTE with `ROW_NUMBER()`. I partition by all columns that define a duplicate, order by something stable, and then `DELETE` where the row number is greater than 1."
